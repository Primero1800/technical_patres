# ОБЩАЯ ИНФОРМАЦИЯ:

Репозиторий содержит тестовое задание компании-рекрутера для претендента на вакансию backend-разработчика на  <b>python</b> .
Задание реализовано на <b>fastapi</b> с асинхронным доступом к базе данных, реализованной на <b>postgres</b>. 



# РУКОВОДСТВО ПО УСТАНОВКЕ И НАСТРОЙКЕ:

1. Клонируйте репозиторий:

	  	https://github.com/Primero1800/technical_patres.git
	
   

	Или скачайте исходный код репозитория в zip-архиве и распакуйте.



2. Создайте и активируйте виртуальное окружение:

		python3 -m venv venv
		source venv/bin/activate

3. Перед запуском обратите внимание на наличие файлов с переменными окружения и ключами:

	<b>.env.public</b> в пакете src - содержит все настройки приложения: префиксы роутеров, теги, настройки базы данных и
			рабочие настройки самого приложения для аутентификации/авторизации и разделов
		
	<b>.env</b> в пакете src - содержит чувствительные настройки приложения: пользователи, пароли (в репозитории
			стоят варианты по умолчанию, как и в доккере)

	<b>jwt-private.pem</b>  и <b>jwt-public.pem</b>в пакете src.core.certs - приватный и публичный ключи для
			генерации и валидации jwt-токена. Рядом в том же каталоге в файле README.md лежит инструкция по
   			генерации ключей. Cами ключи по умолчанию прилагаются к проекту.

4. Запустите команду по созданию контейнера и запуска приложения, предварительно убедившись, что localhost:8000 свободен,
а системный postgres отключен:
			
		docker-compose up --build -V

5. В браузере:
		
		localhost:8000/docs


# ЭНДПОЙНТЫ:


<b>AUTHORIZATION</b>:

<b><i>api/v1/auth/login POST</i></b> - вход по емэйл и паролю для ранее зарегистрированных пользователей. Возвращает access-token
		
<b><i>api/v1/auth/registration POST</i></b> - регистрация нового пользователя в системе с сохранением информации в базе данных


	
<b>BOOKS</b>:

<b><i>api/v1/books GET</i></b> - получение списка книг из базы данных без приватной информации: количество, id

<b><i>api/v1/books POST</i></b> - создание нового экземпляра книги (для зарегистрированных пользователей)

<b><i>api/v1/books/full GET</i></b> - получение списка книг из базы данных c приватной информацией: количество, id и
			историей пользования (для зарегистрированных пользователей)

<b><i>api/v1/books/{id} GET</i></b> - получение информации по выбранной книге (для зарегистрированных пользователей)

<b><i>api/v1/books/{id} DELETE</i></b> - удаление выбранной книги с каскадным удалением всей информации о ее выдаче
			(для зарегистрированных пользователей)

<b><i>api/v1/books/{id} PUT</i></b> - изменение данных выбранной книги (для зарегистрированных пользователей)

<b><i>api/v1/books/{id} PATCH</i></b> - частичное изменение данных выбранной книги (для зарегистрированных пользователей)

<b><i>api/v1/books/{id}/full GET</i></b> - получение полной информации о книге с историей пользования (для зарегистрированных пользователей)



<b>READERS</b>:

<b><i>api/v1/readers GET</i></b> - получение списка читателей из базы данных (для зарегистрированных пользователей)

<b><i>api/v1/readers POST</i></b> - регистрация нового читателя в базе данных (для зарегистрированных пользователей)

<b><i>api/v1/readers/full GET</i></b> - получение списка читателей из базы данных c историей пользования книгами 
			(для зарегистрированных пользователей)

<b><i>api/v1/readers/{id} GET</i></b> - получение информации по выбранному читателю (для зарегистрированных пользователей)

<b><i>api/v1/readers/{id} DELETE</i></b> - удаление выбранного читателя из базы данных с каскадным удалением всей информации 
			о пользовании книгами (для зарегистрированных пользователей)

<b><i>api/v1/readers/{id} PUT</i></b> - изменение данных выбранного читателя (для зарегистрированных пользователей)

<b><i>api/v1/books/{id} PATCH</i></b> - частичное изменение данных выбранного читателя (для зарегистрированных пользователей)

<b><i>api/v1/books/{id}/full GET</i></b> - получение полной информации о читателе с историей пользования книгами
			(для зарегистрированных пользователей)

<b><i>api/v1/books/{id}/actual GET</i></b> - получение информации о читателе с книгами на руках в данный момент
			(для зарегистрированных пользователей)


<b>LIBRARY</b>:
		
<b><i>api/v1/library/serve POST</i></b> - запрос на выдачу книги. Работает только в случае:
	<ul>
		<li>если читатель с указанным reader_id существует</li>
		<li>если книга с указанным book_id существует</li>
		<li>если книга есть в наличии (quantity > 1)</li>
		<li>если у пользователя на руках еще нет такой книги (второй экземпляр не выдается)</li>
		<li>если количество книг на руках пользователя не превышает указанного количества 
			(параметр READERS_MAX_ITEMS_AT_ONCE в .env.public - по умолчанию 3)</li>
   	</ul>
	<p>При выдаче количество книг на складе уменьшается на 1 (для зарегистрированных пользователей)</p>

<b><i>api/v1/library/serve POST</i></b> - запрос на возврат книги. Работает по borrow_id в случае:
	<ul>
		<li>идентификатор указывает на незакрытую позицию (нет даты возврата)</li>
  	</ul>
		При возврате количество книг на складе увеличивается на 1 (для зарегистрированных пользователей)

<b><i>api/v1/library/info/{reader_id} GET</i></b> - просмотр списка книг "на руках" у выбранного пользователя
			(для зарегистрированных пользователей)


# СТРУКТУРА ПРОЕКТА:
		
	CORE:
		1. models - ORM-модели 
		2. config - Конфигураторы (application, database, exception_handler, swagger)
		3. certs - Пакет с ключами для jwt-аутентификации
		4. settings.py - Файл настроки, аггрегирующий все данные из виртуального окружения

	API:
		1. Auth - пакет настроек fastapi-users со своим роутером, сервисом, менеджером, схемами и зависимостями
		2. Books - раздел книг с роутером, сервисом, репозиторием, зависимостями и служебными файлами
		3. Readers - раздел книг с роутером, сервисом, репозиторием, зависимостями и служебными файлами
		4. Library - раздел управления библиотекой с роутером, сервисом, репозиторием, зависимостями и служебными
  		файлами

	SCRIPTS, TOOLS:
		Пакеты со скриптами и рабочими инструментами


# РЕАЛИЗАЦИЯ ПРОЕКТА:


При реализации проекта решено было использовать:
	<ul>
		<li><b>asyncpg</b> - для асинхронных запросов к бд postgres</li>
		<li><b>alembic</b> - для создания и редактирования структур базы данных, как наиболее удобный и логичный инструмент</li>
		<li><b>fastapi-users</b> - реализации работы с пользователями. Для аутентификации была выбрана jwt-стратегия.
			Созданы файлы с ключами в папке src/core/certs</li>
		<li><b>pydantic-settings</b> - для работы с виртуальным окружением и .env-файлами</li>
   	</ul>


# ПОЯСНЕНИЯ ПО РЕАЛИЗАЦИИ:


<ul>
	<li>Директория <b>static</b> с файлами для Swagger, как и сам конфигуратор Swagger используются потому, что некоторые интернет-провайдеры
	ограничили доступ к официальному сайту fastapi и связанным ресурсам (в частности "Белтелеком", возможно и другие)</li>
	<li><b>fastapi-users</b> был выбран из-за его удобства и удачно подходит для поставленной задачи - обеспечивает хэширование паролей и
	все необходимое для jwt-аутентификации. В связи с этим в качестве feature для апгрейда просятся остальные его возможности:
 	<ul>
		<li>Настройка суперпользователя (библиотекаря)</li>
		<li>Обычному пользователю оставляется возможноть лишь просмотра личных данных</li>
		<li>Верификация пользователей с отправкой токена на почтовый ящик</li>
		<li>Восстановление пароля, так же с отправкой токена на ящик</li>
  	</ul>
</li>
	<li><b>база данных</b> - для хранения данных используются 4 таблицы. Интерес представляет pat_borrowed_book с "родственными"
	связями как с pat_reader, так и с pat_book. Что позволяет легко делать выборку между книгами/читателями</li>
	<li><b>Возврат книги</b> - используется при запросе идентификатор borrow_id, который четко указывает на пару книга-читатель.
	Это исключает вероятность отсутствия книги, читателя или выдачи книги. Остается лишь проверить, что нет даты 
	возврата (отсечь повторный возврат)</li>
	<li><b>Эндпоинт для получения списка всех книг</b> - сделано 2: один без id и quantity для общего доступа, а второй 
	кроме id и quantity возвращает еще и дополнительно историю пользования книг (для администрации).</li>
	<li><b>alembic миграции</b>. Здесь небольшие вопросы вызвало само задание, поэтому миграции три:
 	<ul>
		<li>в первой созданы все таблицы и таблица книг без description</li>
		<li>во второй добавлено поле description nullable=True, default=None, server_default=None, что автоматически по 
			применению привело к добавлению [NULL] значений в базе данных к уже существующим записям</li>
		<li>третья миграция с изменением поля descri[tion теперь уже nullable=False, default='unknown', server_default='unknown'
			из-за того, что в базе данных уже были записи с [NULL] для срабатывания потребовала внесения изменений в файл миграции
			для корректного исправления ранее [NULL] данных на "unknown"</li>
     	</ul>
     	</li>
	<li><b>features</b>. Кроме дополнения проекта до полноценной регистрации с валидацией, отправкой токена на почтовый ящик
	и возможности восстановления пароля в случае утери просятся в первую очередь:
 	<ul>
		<li>дублирование эдпоинтов по признаку me (для аутентифицированного пользователя) и кастомного {id} - для 
			суперпользователя (библиотекаря)</li>
		<li>Полноценная реализация аутентификации с верификацией с помощью отправки токена на почтовый ящик. А также добавление 
			возможности восстановления утерянного пароля, так же с отправкой соответствующего токена на почтовый
			ящик. Функции рассылки предлагаю переложить на <b>celery</b> воркера с <b>redis</b> в качестве брокера.</li>
		<li>добавление <b>RateLimiter</b> для эндпойнтов с хранением данных в <b>redis</b>b> или хотя бы in memory на хосте.</li>
   	</ul>
   	</li>
   </ul>
