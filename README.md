# ОБЩАЯ ИНФОРМАЦИЯ:

Репозиторий содержит тестовое задание компании-рекрутера для претендента на вакансию backend-разработчика на  <b>python</b> .
Задание реализовано на <b>fastapi</b> с асинхронным доступом к базе данных, реализованной на <b>postgres</b>. 



# РУКОВОДСТВО ПО УСТАНОВКЕ И НАСТРОЙКЕ:

1. Клонируйте репозиторий:

	  	https://github.com/Primero1800/technical_patres.git
	
   

	Или скачайте исходный код репозитория в zip-архиве и распакуйте.



2. Создайте и активируйте виртуальное окружение:

		python3 -m venv venv
		source venv/bin/activate

3. Перед запуском обратите внимание на наличие файлов с переменными окружения и ключами:

		.env.public в пакете src - содержит все настройки приложения: префиксы роутеров, теги, настройки базы данных и
			рабочие настройки самого приложения для аутентификации/авторизации и разделов
		
		<b>.env</b> в пакете src - содержит чувствительные настройки приложения: пользователи, пароли (в репозитории
			стоят варианты по умолчанию, как и в доккере)

		<b>jwt-private.pem</b>  и <b>jwt-public.pem</b>в пакете src.core.certs - приватный и публичный ключи для
			генерации и валидации jwt-токена. Рядом в том же каталоге в файле README.md лежит инструкция по
   			генерации ключей. Cами ключи по умолчанию прилагаются к проекту.

4. Запустите команду по созданию контейнера и запуска приложения, предварительно убедившись, что localhost:8000 свободен,
а системный postgres отключен:
			
		docker-compose up --build -V

5. В браузере:
		
		localhost:8000/docs


# ЭНДПОЙНТЫ:

	Authorization:

		<b>api/v1/auth/login POST</b> - вход по емэйл и паролю для ранее зарегистрированных пользователей. Возвращает access-token
		
		<b>api/v1/auth/registration POST</b> - регистрация нового пользователя в системе с сохранением информации в базе данных

	
	Books:

		<b>api/v1/books GET</b> - получение списка книг из базы данных без приватной информации: количество, id
	
		<b>api/v1/books POST</b> - создание нового экземпляра книги (для зарегистрированных пользователей)
	
		<b>api/v1/books/full GET</b> - получение списка книг из базы данных c приватной информацией: количество, id и
																историей пользования (для зарегистрированных пользователей)
	
		<b>api/v1/books/{id} GET</b> - получение информации по выбранной книге (для зарегистрированных пользователей)
	
		<b>api/v1/books/{id} DELETE</b> - удаление выбранной книги с каскадным удалением всей информации о ее выдаче
																(для зарегистрированных пользователей)

		<b>api/v1/books/{id} PUT</b> - изменение данных выбранной книги (для зарегистрированных пользователей)
	
		<b>api/v1/books/{id} PATCH</b> - частичное изменение данных выбранной книги (для зарегистрированных пользователей)
	
		<b>api/v1/books/{id}/full GET</b> - получение полной информации о книге с историей пользования (для зарегистрированных пользователей)


	Readers:

		<b>api/v1/readers GET</b> - получение списка читателей из базы данных (для зарегистрированных пользователей)
	
		<b>api/v1/readers POST</b> - регистрация нового читателя в базе данных (для зарегистрированных пользователей)
	
		<b>api/v1/readers/full GET</b> - получение списка читателей из базы данных c историей пользования книгами 
																(для зарегистрированных пользователей)
	
		<b>api/v1/readers/{id} GET</b> - получение информации по выбранному читателю (для зарегистрированных пользователей)
	
		<b>api/v1/readers/{id} DELETE</b> - удаление выбранного читателя из базы данных с каскадным удалением всей информации 
																о пользовании книгами (для зарегистрированных пользователей)
	
		<b>api/v1/readers/{id} PUT</b> - изменение данных выбранного читателя (для зарегистрированных пользователей)

		<b>api/v1/books/{id} PATCH</b> - частичное изменение данных выбранного читателя (для зарегистрированных пользователей)
	
		<b>api/v1/books/{id}/full GET</b> - получение полной информации о читателе с историей пользования книгами
																(для зарегистрированных пользователей)
	
		<b>api/v1/books/{id}/actual GET</b> - получение информации о читателе с книгами на руках в данный момент
																(для зарегистрированных пользователей)

	
	Library:
		
		<b>api/v1/library/serve POST</b> - запрос на выдачу книги. Работает только в случае:
					- если читатель с указанным reader_id существует
					- если книга с указанным book_id существует
					- если книга есть в наличии (quantity > 1)
					- если у пользователя на руках еще нет такой книги (второй экземпляр не выдается)
					- если количество книг на руках пользователя не превышает указанного количества 
						(параметр READERS_MAX_ITEMS_AT_ONCE в .env.public - по умолчанию 3)
			При выдаче количество книг на складе уменьшается на 1 (для зарегистрированных пользователей)

		<b>api/v1/library/serve POST</b> - запрос на возврат книги. Работает по borrow_id в случаеЖ
					- идентификатор указывает на незакрытую позицию (нет даты возврата)
			При возврате количество книг на складе увеличивается на 1 (для зарегистрированных пользователей)

		<b>api/v1/library/info/{reader_id}</b> - просмотр списка книг "на руках" у выбранного пользователя
																	(для зарегистрированных пользователей)


# СТРУКТУРА ПРОЕКТА:
		
	CORE:
		1. models - ORM-модели 
		2. config - Конфигураторы (application, database, exception_handler, swagger)
		3. certs - Пакет с ключами для jwt-аутентификации
		4. settings.py - Файл настроки, аггрегирующий все данные из виртуального окружения

	API:
		1. Auth - пакет настроек fastapi-users со своим роутером, сервисом, менеджером, схемами и зависимостями
		2. Books - раздел книг с роутером, сервисом, репозиторием, зависимостями и служебными файлами
		3. Readers - раздел книг с роутером, сервисом, репозиторием, зависимостями и служебными файлами
		4. Library - раздел управления библиотекой с роутером, сервисом, репозиторием, зависимостями и служебными файлами

	SCRIPTS, TOOLS:
		Пакеты со скриптами и рабочими инструментами


# РЕАЛИЗАЦИЯ ПРОЕКТА:

	1. При реализауции проекта решено было использовать:
			a) asyncpg - для асинхронных запросов к бд postgres
			б) alembic - для создания и редактирования структур базы данных
			в) fastapi-users - реализации работы с пользователями. Для аутентификации была выбрана jwt-стратегия.
					Созданы файлы с ключами в папке src/core/certs
			г) pydantic-settings - для работы с виртуальным окружением и .env-файлами


# ПОЯСНЕНИЯ ПО РЕАЛИЗАЦИИ:

	- Директория <b>static</b> с файлами для Swagger, как и сам конфигуратор Swagger используются потому, что некоторые интернет-провайдеры
	ограничили доступ к официальному сайту fastapi и связанным ресурсам (в частности "Белтелеком", возможно и другие)

	- <b>fastapi-users</b> был выбран из-за его удобства и удачно подходит для поставленной задачи - обеспечивает хэширование паролей и
	все необходимое для jwt-аутентификации. В связи с этим в качестве feature для апгрейда просятся остальные его возможности:
		- Настройка суперпользователя (библиотекаря)
		- Обычному пользователю оставляется возможноть лишь просмотра личных данных
		- Верификация пользователей с отправкой токена на почтовый ящик
		- Восстановление пароля, так же с отправкой токена на ящик

	- <b>база данных</b> - для хранения данных используются 4 таблицы. Интерес представляет pat_borrowed_book с "родственными"
	связями как с pat_reader, так и с pat_book. Что позволяет легко делать выборку между книгами/читателями

	- <b>Возврат книги</b> - используется при запросе идентификатор borrow_id, который четко указывает на пару книга-читатель.
	Это исключает вероятность отсутствия книги, читателя или выдачи книги. Остается лишь проверить, что нет даты 
	возврата (отсечь повторный возврат)

	-<b>Эндпоинт для получения списка всех книг</b> - сделано 2: один без id и quantity для общего доступа, а второй 
	кроме id и quantity возвращает еще и дополнительно историю пользования книг (для администрации).

	-<b>alembic миграции</b>. Здесь небольшие вопросы вызвало само задание, поэтому миграции три:
			- в первой созданы все таблицы и таблица книг без description
			- во второй добавлено поле description nullable=True, default=None, server_default=None, что автоматически по 
					применению привело к добавлению [NULL] значений в базе данных к уже существующим записям
			- третья миграция с изменением поля descri[tion теперь уже nullable=False, default='unknown', server_default='unknown'
					из-за того, что в базе данных уже были записи с [NULL] для срабатывания потребовала внесения изменений в файл миграции
					для корректного исправления ранее [NULL] данных на "unknown"

	-<b>features</b>. Кроме дополнения проекта до полноценной регистрации с валидацией, отправкой токена на почтовый ящик
	и возможности восстановления пароля в случае утери просятся в первую очередь:
			- дублирование эдпоинтов по признаку me (для аутентифицированного пользователя) и кастомного {id} - для 
					суперпользователя (библиотекаря)
			- добавление RateLimiter для эндпойнтов с хранением данных в redis или хотя бы in memory на хосте.
